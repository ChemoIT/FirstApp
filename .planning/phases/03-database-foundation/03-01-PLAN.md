---
phase: 03-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [".gitignore", "api/config.php", "api/supabase.php", "api/test-supabase.php"]
autonomous: false
user_setup:
  - service: supabase
    why: "Cloud PostgreSQL database for user management"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard > Settings > API > Project URL"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard > Settings > API > service_role (or Secret key in new UI)"
    dashboard_config:
      - task: "Run CREATE TABLE SQL in SQL Editor"
        location: "Supabase Dashboard > SQL Editor > New query"

must_haves:
  truths:
    - "public.users table exists in Supabase with all 12 columns (id, first_name, last_name, id_number, phone, gender, foreign_worker, email, password_hash, status, suspended_until, created_at, updated_at)"
    - "api/config.php contains SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY constants and is NOT tracked by git"
    - "A GET request to /rest/v1/users via api/supabase.php returns HTTP 200 with an empty JSON array []"
  artifacts:
    - path: ".gitignore"
      provides: "Prevents api/config.php from being committed to git"
      contains: "api/config.php"
    - path: "api/config.php"
      provides: "Centralized credentials — Micropay + Supabase constants"
      contains: "SUPABASE_URL"
    - path: "api/supabase.php"
      provides: "Shared cURL helper function for all Supabase REST API calls"
      contains: "function supabase_request"
    - path: "api/test-supabase.php"
      provides: "Temporary connection test script (deleted after verification)"
      contains: "supabase_request"
  key_links:
    - from: "api/supabase.php"
      to: "api/config.php"
      via: "require_once __DIR__ . '/config.php'"
      pattern: "require_once.*config\\.php"
    - from: "api/supabase.php"
      to: "Supabase REST API"
      via: "cURL with dual-header (apikey + Authorization: Bearer)"
      pattern: "apikey.*SUPABASE_SERVICE_ROLE_KEY"
    - from: "api/test-supabase.php"
      to: "api/supabase.php"
      via: "require_once, calls supabase_request('GET', '/users')"
      pattern: "supabase_request.*GET.*users"
---

<objective>
Create the Supabase database table, PHP connection layer, and credential management that every subsequent phase depends on.

Purpose: Phase 3 is the foundation — phases 4-6 all require a working Supabase connection and a users table. Nothing else can be built until this works end to end.

Output: `.gitignore`, updated `api/config.php` (with Supabase credentials, untracked from git), `api/supabase.php` (reusable cURL helper), and a verified live connection returning `[]` from the empty users table.
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-database-foundation/03-RESEARCH.md
@api/config.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .gitignore, untrack config.php, write supabase.php helper and test file</name>
  <files>.gitignore, api/config.php, api/supabase.php, api/test-supabase.php</files>
  <action>
**Step 1 — Create `.gitignore` in project root** with these entries:

```gitignore
# Server credentials — never commit
api/config.php

# OS / Editor noise
.DS_Store
Thumbs.db
.idea/
.vscode/settings.json
*.swp
```

**Step 2 — Untrack config.php from git.** Run:

```bash
git rm --cached api/config.php
git add .gitignore
git commit -m "chore(03): stop tracking config.php, add .gitignore"
```

This removes config.php from git's index WITHOUT deleting the physical file. After this commit, `git status` must NOT show `api/config.php` under any section (staged, modified, or untracked — because .gitignore now excludes it).

**Step 3 — Add Supabase placeholder constants to `api/config.php`.** Append these lines BELOW the existing constants (do NOT modify the existing Micropay/admin constants):

```php

// === Supabase (Phase 3) ===
// Project URL — found in: Dashboard > Settings > API > Project URL
// Format: https://<project_ref>.supabase.co
define('SUPABASE_URL', 'REPLACE_ME');

// service_role key — found in: Dashboard > Settings > API Keys > service_role
// (New Supabase UI may call this "Secret key" starting with sb_secret_)
// NEVER expose this key client-side. It bypasses Row Level Security.
define('SUPABASE_SERVICE_ROLE_KEY', 'REPLACE_ME');
```

The placeholders `'REPLACE_ME'` will be replaced by Sharon in Task 2. config.php is now untracked, so this edit will NOT be committed.

**Step 4 — Create `api/supabase.php`** — the shared cURL helper function for all Supabase REST API calls. Use the exact implementation from 03-RESEARCH.md Pattern 2:

- `function supabase_request(string $method, string $path, ?array $body = null, bool $prefer_rep = false): array`
- Must `require_once __DIR__ . '/config.php'`
- DUAL-HEADER REQUIREMENT: Both `apikey: SUPABASE_SERVICE_ROLE_KEY` and `Authorization: Bearer SUPABASE_SERVICE_ROLE_KEY` headers must be set. The `Authorization` header is what bypasses RLS.
- Include `Content-Type: application/json` header
- Optional `Prefer: return=representation` header when `$prefer_rep` is true
- `CURLOPT_RETURNTRANSFER = true`, `CURLOPT_TIMEOUT = 15`, `CURLOPT_SSL_VERIFYPEER = true`
- Attach JSON-encoded body for POST/PATCH
- Return associative array: `['data' => decoded JSON, 'http_code' => int, 'error' => string|null]`
- No closing `?>` tag (Phase 1 pattern: prevents trailing whitespace)

**Step 5 — Create `api/test-supabase.php`** — temporary test script:

```php
<?php
// api/test-supabase.php — TEMPORARY test file, DELETE after verification
// Access in browser: https://ch-ah.info/FirstApp/api/test-supabase.php

require_once __DIR__ . '/supabase.php';

$result = supabase_request('GET', '/users?select=*');

header('Content-Type: application/json');
echo json_encode($result);
// Expected: {"data":[],"http_code":200,"error":null}
```

No closing `?>` tag.
  </action>
  <verify>
1. Run `git status` — `api/config.php` must NOT appear under any section (staged, modified, or untracked)
2. Run `git diff --cached` — `.gitignore` should be staged (if not yet committed)
3. Verify `api/config.php` still exists on disk with both Micropay and Supabase constants: `ls api/config.php` succeeds
4. Verify `api/supabase.php` contains `function supabase_request` and both header lines (`apikey` and `Authorization: Bearer`)
5. Verify `api/test-supabase.php` exists and calls `supabase_request('GET', '/users?select=*')`
  </verify>
  <done>
- `.gitignore` exists with `api/config.php` entry
- `api/config.php` is untracked by git and contains SUPABASE_URL + SUPABASE_SERVICE_ROLE_KEY placeholder constants
- `api/supabase.php` exists with the dual-header cURL helper function
- `api/test-supabase.php` exists as a temporary connection test
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Sharon creates Supabase table and adds credentials</name>
  <action>
Sharon needs to complete two things in order:

**Part A — Create the `users` table in Supabase**

1. Open the Supabase Dashboard: https://supabase.com/dashboard
2. Select your project
3. In the left sidebar, click **SQL Editor**
4. Click **New query** (top right)
5. Paste the following SQL and click **Run**:

```sql
-- Creates the public.users table for FirstApp User Management
CREATE TABLE IF NOT EXISTS public.users (
    id              BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    first_name      TEXT        NOT NULL,
    last_name       TEXT        NOT NULL,
    id_number       TEXT        NOT NULL UNIQUE,
    phone           TEXT        NOT NULL,
    gender          TEXT        NOT NULL CHECK (gender IN ('male', 'female')),
    foreign_worker  BOOLEAN     NOT NULL DEFAULT false,
    email           TEXT        NOT NULL UNIQUE,
    password_hash   TEXT        NOT NULL,
    status          TEXT        NOT NULL DEFAULT 'active'
                                CHECK (status IN ('active', 'blocked', 'suspended')),
    suspended_until TIMESTAMPTZ NULL,
    created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE OR REPLACE FUNCTION public.set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER users_set_updated_at
    BEFORE UPDATE ON public.users
    FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

COMMENT ON TABLE public.users IS
    'Application users for FirstApp. Auth is PHP session-based with bcrypt passwords. No Supabase GoTrue.';
```

6. You should see "Success. No rows returned" — this means the table was created
7. To verify: click **Table Editor** in the left sidebar — you should see a `users` table with 0 rows and all 13 columns

**Part B — Add your Supabase credentials to config.php**

1. In Supabase Dashboard: left sidebar > **Settings** > **API**
2. Copy the **Project URL** (looks like `https://xxxxxxxx.supabase.co`)
3. Copy the **service_role** key (under API Keys section — it may be labeled "service_role" or "Secret key" depending on your dashboard version). Click "Reveal" to see it.
4. Open `api/config.php` on your local machine
5. Replace the two `'REPLACE_ME'` values:
   - Replace `SUPABASE_URL` value with your Project URL
   - Replace `SUPABASE_SERVICE_ROLE_KEY` value with your service_role key
6. Save the file

**IMPORTANT:** The service_role key has full database access. Never share it or put it in client-side code.
  </action>
  <resume-signal>Type "done" when both the table is created and credentials are pasted into config.php</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify live Supabase connection and clean up test file</name>
  <action>
Verify the live Supabase connection works end to end, then delete the test file.

What was built: Supabase connection from PHP — table created, credentials configured, cURL helper ready.
  </action>
  <how-to-verify>
**Pre-flight: Deploy files to server**

Push the new files to GitHub so they deploy via the existing CI/CD pipeline:
```bash
git add api/supabase.php api/test-supabase.php
git commit -m "feat(03-01): add Supabase cURL helper and test script"
git push
```

Wait for the GitHub Action to complete (check https://github.com/ChemoIT/FirstApp/actions).

**IMPORTANT:** Also upload `api/config.php` manually via cPanel File Manager (because it is NOT in git). Navigate to `public_html/FirstApp/api/` and upload the local `api/config.php` with the real Supabase credentials.

**Verification steps:**

1. Open in browser: `https://ch-ah.info/FirstApp/api/test-supabase.php`
2. Expected response: `{"data":[],"http_code":200,"error":null}`

**If you see `{"data":null,"http_code":0,"error":"...SSL..."}:`** The server has an SSL certificate issue with cURL. Check cPanel PHP settings for `curl.cainfo`.

**If you see `{"data":{"message":"..."},"http_code":401,"error":null}:`** The service_role key in config.php is wrong. Double-check the key in Supabase Dashboard.

**If you see `{"data":[],"http_code":200,"error":null}`:** Everything works. The empty array `[]` means the table exists and the connection is authenticated.

3. After successful verification: **DELETE `api/test-supabase.php`** from the server (via cPanel File Manager) — it exposes the Supabase connection to anyone with the URL. Also remove it from the local repo:
```bash
git rm api/test-supabase.php
git commit -m "chore(03): remove test-supabase.php after verification"
git push
```
  </how-to-verify>
  <verify>Browser shows {"data":[],"http_code":200,"error":null} at https://ch-ah.info/FirstApp/api/test-supabase.php</verify>
  <done>Live Supabase connection returns HTTP 200 with empty array, proving dual-header auth works. Test file deleted from server and repo.</done>
  <resume-signal>Type "verified" if the test returned {"data":[],"http_code":200,"error":null}, or describe the error you see</resume-signal>
</task>

</tasks>

<verification>
Phase 3 is complete when ALL of these are true:

1. **DB-01 (Table exists):** The `public.users` table is visible in Supabase Dashboard Table Editor with 13 columns: id, first_name, last_name, id_number, phone, gender, foreign_worker, email, password_hash, status, suspended_until, created_at, updated_at
2. **DB-03 (Credentials secured):** `api/config.php` contains `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` with real values, and `git status` does NOT show `api/config.php`
3. **DB-02 (Connection works):** A live GET request via `api/supabase.php` to `/rest/v1/users` returned HTTP 200 with `[]` — proving the dual-header cURL helper works
4. **Cleanup:** `api/test-supabase.php` has been deleted from both local repo and server
</verification>

<success_criteria>
- `public.users` table exists in Supabase with all required columns and the updated_at trigger
- `api/config.php` is untracked by git and contains working Supabase credentials
- `api/supabase.php` provides a reusable `supabase_request()` function with dual-header auth
- A live connection test returned `{"data":[],"http_code":200,"error":null}`
- `api/test-supabase.php` is deleted after verification
- Phase 4 can safely `require_once __DIR__ . '/supabase.php'` and call `supabase_request()` against the `users` table
</success_criteria>

<output>
After completion, create `.planning/phases/03-database-foundation/03-01-SUMMARY.md`
</output>
