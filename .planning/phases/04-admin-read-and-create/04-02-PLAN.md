---
phase: 04-admin-read-and-create
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - admin.php
autonomous: false

must_haves:
  truths:
    - "Admin navigates to /FirstApp/admin.php and sees Hebrew RTL page with user table and create form"
    - "User table loads and displays users fetched from api/users/list.php"
    - "Admin fills create form, submits, new user appears in table without page reload"
    - "Invalid email shows Hebrew error before and after server call"
    - "Password under 8 chars shows Hebrew error before and after server call"
    - "Password generator button inserts random secure password into field"
    - "Search box filters table rows live by name, email, or ID number"
  artifacts:
    - path: "admin.php"
      provides: "Full admin page with user table, search, create form, password generator"
      min_lines: 150
  key_links:
    - from: "admin.php"
      to: "api/users/list.php"
      via: "fetch() on DOMContentLoaded to load user table"
      pattern: "fetch.*api/users/list"
    - from: "admin.php"
      to: "api/users/create.php"
      via: "fetch() on form submit to create user"
      pattern: "fetch.*api/users/create"
    - from: "admin.php"
      to: "crypto.getRandomValues"
      via: "password generator button click handler"
      pattern: "crypto\\.getRandomValues"
---

<objective>
Build the admin.php page with Bootstrap 5.3 RTL layout, user table, live search, create form with validation, and password generator.

Purpose: This is the user-facing admin interface that ties together the API endpoints from Plan 04-01 into a usable page. Covers ADMIN-01, ADMIN-02, ADMIN-05, ADMIN-06, ADMIN-07, ADMIN-12, and the frontend half of ADMIN-03 and ADMIN-04.
Output: `admin.php` — a complete, working admin page accessible at `/FirstApp/admin.php`.
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-read-and-create/04-RESEARCH.md
@.planning/phases/04-admin-read-and-create/04-01-SUMMARY.md
@api/supabase.php
@index.html
@css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin.php — full admin page with table, search, form, and password generator</name>
  <files>admin.php</files>
  <action>
Create `admin.php` in the project root (same level as index.html, dashboard.html).

**HTML structure:**
- `<!DOCTYPE html>`, `<html lang="he" dir="rtl">` (ADMIN-12: Hebrew RTL)
- `<title>ניהול משתמשים</title>`
- Load Bootstrap 5.3 RTL CSS via CDN: `https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.rtl.min.css`
- Load existing `css/style.css` after Bootstrap (for shared font, colors)
- Use `<div class="container-lg py-4">` as main wrapper (wider than the 400px login container)
- Page heading: `<h1 class="mb-4">ניהול משתמשים</h1>`

**Section 1: Search box (ADMIN-07)**
- `<input type="search" id="search-box" class="form-control mb-3" placeholder="חיפוש לפי שם, אימייל או מספר זהות">`
- JS: On `input` event, filter `#users-tbody tr` rows — check if `row.textContent.toLowerCase()` includes the query. Show/hide with `row.style.display`.

**Section 2: User table (ADMIN-06)**
- Responsive wrapper: `<div class="table-responsive mb-5">`
- `<table class="table table-striped table-hover align-middle" id="users-table">`
- 7 column headers in `<thead class="table-dark">`: מזהה, שם פרטי, שם משפחה, מספר זהות, אימייל, טלפון, סטטוס
- `<tbody id="users-tbody">` — populated by JS on page load
- If the API returns an empty array, show a single row spanning all columns: `<td colspan="7" class="text-center text-muted">אין משתמשים במערכת</td>`

**Section 3: Create user form (ADMIN-02)**
- Heading: `<h2 class="mb-3">הוספת משתמש חדש</h2>`
- `<form id="create-form" novalidate>` — novalidate to control validation in JS
- Form fields (each in a `<div class="mb-3">`):
  1. שם פרטי — `<input type="text" id="first_name" class="form-control" required>`
  2. שם משפחה — `<input type="text" id="last_name" class="form-control" required>`
  3. מספר זהות — `<input type="text" id="id_number" class="form-control" required>`
  4. טלפון — `<input type="tel" id="phone" class="form-control" required>` + JS strips non-digits on input (ADMIN-02: digits only)
  5. מגדר — `<select id="gender" class="form-select" required>` with options: `<option value="">בחר מגדר</option>`, `<option value="male">זכר</option>`, `<option value="female">נקבה</option>`
  6. עובד זר — `<div class="form-check mb-3"><input type="checkbox" id="foreign_worker" class="form-check-input"><label class="form-check-label" for="foreign_worker">עובד זר</label></div>`
  7. אימייל — `<input type="email" id="email" class="form-control" required>` (ADMIN-03 frontend)
  8. סיסמא — `<div class="input-group">`: `<input type="password" id="password" class="form-control" minlength="8" required>` + `<button type="button" id="generate-pw-btn" class="btn btn-outline-secondary">צור סיסמא</button>` (ADMIN-05)

- Submit button: `<button type="submit" class="btn btn-primary mt-3">הוסף משתמש</button>`
- Error div: `<div id="form-error" class="alert alert-danger mt-3" style="display:none;"></div>`
- Success div: `<div id="form-success" class="alert alert-success mt-3" style="display:none;"></div>`

**JavaScript (inline `<script>` at bottom, before closing `</body>`):**

Load Bootstrap JS bundle before the inline script:
`<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>`

All JS uses ES5 `.then()` chain pattern (consistent with index.html — no async/await).

1. **loadUsers() function:**
   - `fetch('api/users/list.php').then(...)`
   - On `data.ok`: Clear tbody, loop `data.users`, create `<tr>` with 7 `<td>` cells (id, first_name, last_name, id_number, email, phone, status)
   - Translate status values for display: 'active' -> `<span class="badge bg-success">פעיל</span>`, 'blocked' -> `<span class="badge bg-danger">חסום</span>`, 'suspended' -> `<span class="badge bg-warning text-dark">מושעה</span>`
   - On error or `!data.ok`: show error message in table area
   - Call `loadUsers()` on `DOMContentLoaded`

2. **Live search (ADMIN-07):**
   - `document.getElementById('search-box').addEventListener('input', function() {...})`
   - Get `this.value.trim().toLowerCase()`, iterate `#users-tbody tr`, show/hide based on `row.textContent.toLowerCase().includes(query)`

3. **Phone digits-only filter (ADMIN-02):**
   - `document.getElementById('phone').addEventListener('input', function() { this.value = this.value.replace(/\D/g, ''); })`

4. **Password generator (ADMIN-05):**
   - `generateSecurePassword(length)` function using `crypto.getRandomValues(new Uint8Array(length))`
   - Character set: `ABCDEFGHIJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$` (ambiguous chars removed)
   - Generate 12-char password
   - On button click: set `password.value` to generated password, change `password.type` to `'text'` so admin can see/copy it

5. **Form validation (ADMIN-03, ADMIN-04 frontend):**
   - `validateForm(data)` function returns error string or null
   - Email regex check: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/` — if fails, return `כתובת אימייל לא תקינה`
   - Password length: `data.password.length < 8` — if fails, return `הסיסמא חייבת לכלול לפחות 8 תווים`
   - Required fields: check all non-empty — if fails, return `כל השדות חובה`

6. **Form submit handler:**
   - `document.getElementById('create-form').addEventListener('submit', function(e) { e.preventDefault(); ... })`
   - Gather all field values into an object
   - Run `validateForm()` — if error, show in `#form-error`, return
   - Hide error/success divs, disable submit button
   - `fetch('api/users/create.php', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })`
   - On `data.ok`: show success message `המשתמש נוצר בהצלחה` in `#form-success`, reset the form, reload the user table by calling `loadUsers()`
   - On `!data.ok`: show `data.message` in `#form-error`
   - On network error: show `שגיאת תקשורת — נסה שוב`
   - Re-enable submit button in all cases (use `.finally()` or duplicate in both then/catch)

**Style notes:**
- Bootstrap 5 handles RTL automatically with `bootstrap.rtl.min.css` + `dir="rtl"`
- Use Bootstrap 5 utility classes: `.ms-*` (not `.ml-*`), `.me-*` (not `.mr-*`)
- The `css/style.css` reset may conflict with Bootstrap. Load Bootstrap FIRST so its classes take priority, then `style.css` for fonts and colors only. If the 400px `.container` max-width from style.css conflicts with `container-lg`, add a scoped override: the admin page uses `container-lg` (Bootstrap) which has a different max-width, but the `.container` rule in style.css targets the generic `.container` class. To avoid conflict, use `container-lg` in admin.php (Bootstrap defines this separately from `.container`) OR add `<style>.container-lg { max-width: none; }</style>` if needed.
- No separate `css/admin.css` file needed — keep it simple with Bootstrap classes + minimal inline style block if needed
  </action>
  <verify>
1. File exists: `ls admin.php` in project root
2. PHP syntax check: `php -l admin.php` (should report no syntax errors even though it is mostly HTML)
3. After deploy (git push triggers CI/CD), open `https://ch-ah.info/FirstApp/admin.php` in browser:
   - Page loads with Hebrew title "ניהול משתמשים"
   - Table shows with 7 column headers (or "אין משתמשים במערכת" if empty)
   - Create form has all 8 fields + password generator button
   - Layout is RTL (labels right-aligned, form controls right-to-left)
  </verify>
  <done>admin.php exists in project root, loads Bootstrap 5.3 RTL, displays user table with 7 columns, has search box, has create form with all required fields (ADMIN-02), has password generator button (ADMIN-05), validates email and password on frontend (ADMIN-03, ADMIN-04), all labels in Hebrew (ADMIN-12)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify admin page end-to-end</name>
  <files>admin.php</files>
  <action>
Human verification of the complete admin page. Claude deploys via git push (CI/CD auto-deploys to cPanel), then pauses for Sharon to verify all 10 checkpoints below. No code changes in this task — verification only.
  </action>
  <verify>
1. Open https://ch-ah.info/FirstApp/admin.php
2. Confirm the page is Hebrew RTL with Bootstrap styling
3. Confirm the user table shows (empty or with data) with 7 column headers
4. Fill in the create form with valid data and submit — verify the new user appears in the table
5. Check Supabase dashboard — verify the user exists and password_hash is a bcrypt string starting with `$2y$`
6. Try submitting with an invalid email (e.g., "notanemail") — verify Hebrew error appears
7. Try submitting with a short password (e.g., "abc") — verify Hebrew error appears
8. Click the password generator button — verify a random password appears in the field
9. Type a name in the search box — verify the table filters live
10. Try creating a user with the same email again — verify duplicate error appears
  </verify>
  <done>Sharon confirms all 10 verification steps pass — the admin page works end to end with Hebrew RTL layout, user creation, validation, password generation, and search filtering</done>
</task>

</tasks>

<verification>
Phase 4 success criteria (all 6 from ROADMAP.md):
1. Admin navigates to /FirstApp/admin.php and sees Hebrew RTL page — verified by checkpoint step 2
2. Admin creates user, appears in table, bcrypt hash in Supabase — verified by checkpoint steps 4-5
3. Invalid email blocked frontend + backend — verified by checkpoint step 6
4. Short password blocked frontend + backend — verified by checkpoint step 7
5. Password generator inserts random password — verified by checkpoint step 8
6. Search filters table live — verified by checkpoint step 9

Requirements coverage:
- ADMIN-01: Page at /FirstApp/admin.php without login (just a PHP file, no auth check)
- ADMIN-02: Form with all fields (first name, last name, ID number, phone digits-only, gender combo, foreign worker checkbox, email, password)
- ADMIN-03: Email validation frontend (JS regex) + backend (filter_var)
- ADMIN-04: Password min 8 chars frontend (JS check) + backend (strlen)
- ADMIN-05: Password generator button with crypto.getRandomValues
- ADMIN-06: User table with 7 key columns
- ADMIN-07: Live search by name, email, or ID
- ADMIN-12: Hebrew labels, RTL layout via Bootstrap RTL CSS
</verification>

<success_criteria>
Sharon can open admin.php, see the user list, create a new user with validated input, use the password generator, and filter the table — all in Hebrew RTL. The full read-and-write data flow works end to end with Supabase.
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-read-and-create/04-02-SUMMARY.md`
</output>
