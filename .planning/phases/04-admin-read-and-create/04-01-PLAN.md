---
phase: 04-admin-read-and-create
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/users/list.php
  - api/users/create.php
autonomous: true

must_haves:
  truths:
    - "GET api/users/list.php returns JSON with ok:true and users array"
    - "POST api/users/create.php with valid data returns ok:true and created user without password_hash"
    - "POST api/users/create.php with invalid email returns 422 with Hebrew error"
    - "POST api/users/create.php with short password returns 422 with Hebrew error"
    - "POST api/users/create.php with duplicate email returns 409 with Hebrew error"
  artifacts:
    - path: "api/users/list.php"
      provides: "GET endpoint returning all users from Supabase"
      exports: ["JSON response with ok and users fields"]
    - path: "api/users/create.php"
      provides: "POST endpoint validating, hashing, inserting user into Supabase"
      exports: ["JSON response with ok and user fields"]
  key_links:
    - from: "api/users/list.php"
      to: "api/supabase.php"
      via: "require_once and supabase_request('GET', '/users?select=...&order=...')"
      pattern: "supabase_request.*GET.*users"
    - from: "api/users/create.php"
      to: "api/supabase.php"
      via: "require_once and supabase_request('POST', '/users', $body, true)"
      pattern: "supabase_request.*POST.*users"
    - from: "api/users/create.php"
      to: "password_hash()"
      via: "PHP native bcrypt hashing before INSERT"
      pattern: "password_hash\\("
---

<objective>
Create the two PHP API endpoints that power the admin page: list all users and create a new user.

Purpose: The admin UI (Plan 04-02) needs backend endpoints to fetch and create users. Building API first allows curl-based verification before any UI exists.
Output: `api/users/list.php` and `api/users/create.php` — both callable via curl and returning JSON.
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-read-and-create/04-RESEARCH.md
@.planning/phases/03-database-foundation/03-01-SUMMARY.md
@api/supabase.php
@api/login.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api/users/list.php — GET all users endpoint</name>
  <files>api/users/list.php</files>
  <action>
Create the `api/users/` subdirectory and the `list.php` file inside it.

This endpoint:
- Accepts GET requests only (return 405 JSON for other methods)
- Calls `supabase_request('GET', '/users?select=id,first_name,last_name,id_number,email,phone,gender,foreign_worker,status,created_at&order=created_at.desc')`
- CRITICAL: Use `__DIR__ . '/../config.php'` and `__DIR__ . '/../supabase.php'` for require_once paths (one level up from `api/users/` to `api/`). The research file says two levels (`../../api/`) but that is wrong for `api/users/` -> `api/` which is only one level up. Verify the directory structure: `api/users/list.php` needs to reach `api/config.php` which is `../config.php` relative to `__DIR__`.
- Sets `Content-Type: application/json; charset=utf-8`
- On success (http_code 200): returns `{"ok": true, "users": [...]}`
- On error: returns HTTP 500 with `{"ok": false, "message": "שגיאה בטעינת המשתמשים"}`
- Uses `JSON_UNESCAPED_UNICODE` flag in all `json_encode()` calls for readable Hebrew in logs
- NEVER includes `password_hash` in the `select` query parameter — it is excluded at the API level
- No closing `?>` tag (established project pattern)

Follow the exact endpoint pattern from `api/login.php`: header first, method check, logic, json_encode response.
  </action>
  <verify>
Run from project root:
```
curl -s https://ch-ah.info/FirstApp/api/users/list.php
```
Expected: `{"ok":true,"users":[]}` (empty array since no users yet)

Also verify 405 for wrong method:
```
curl -s -X POST https://ch-ah.info/FirstApp/api/users/list.php
```
Expected: HTTP 405 with `{"ok":false,"message":"Method not allowed"}`

If testing locally is not possible, verify the file exists and PHP syntax is valid: `php -l api/users/list.php`
  </verify>
  <done>api/users/list.php exists, returns JSON with ok:true and empty users array from Supabase, rejects non-GET methods with 405</done>
</task>

<task type="auto">
  <name>Task 2: Create api/users/create.php — POST new user endpoint</name>
  <files>api/users/create.php</files>
  <action>
Create `api/users/create.php` in the same subdirectory.

This endpoint:
- Accepts POST requests only (return 405 JSON for other methods)
- Reads JSON body from `php://input` and decodes with `json_decode(..., true)`
- Uses `__DIR__ . '/../config.php'` and `__DIR__ . '/../supabase.php'` for require_once (same one-level-up path as list.php)
- Sets `Content-Type: application/json; charset=utf-8`

**Server-side validation (all return HTTP 422 with Hebrew JSON error):**
1. Required fields check: first_name, last_name, id_number, phone, email, password, gender — all must be non-empty after trim. Message: `כל השדות חובה`
2. Email validation: `filter_var($email, FILTER_VALIDATE_EMAIL)` — if fails, message: `כתובת אימייל לא תקינה` (ADMIN-03)
3. Password length: `strlen($password) < 8` — if fails, message: `הסיסמא חייבת לכלול לפחות 8 תווים` (ADMIN-04)
4. Gender whitelist: must be `'male'` or `'female'` — if fails, message: `ערך מגדר לא תקין`
5. Phone digits-only: `preg_match('/^\d+$/', $phone)` — if fails, message: `מספר טלפון חייב לכלול ספרות בלבד`

**Password hashing:**
- `$passwordHash = password_hash($password, PASSWORD_DEFAULT);` — PHP native bcrypt, no manual salt

**Supabase INSERT:**
- Call `supabase_request('POST', '/users', $data, true)` — the `true` flag adds `Prefer: return=representation`
- `$data` array: first_name, last_name, id_number, phone, gender, foreign_worker (cast to bool), email, password_hash, status set to `'active'`
- Expected success: http_code 201
- On success: take `$result['data'][0]`, run `unset($created['password_hash'])`, return `{"ok": true, "user": {...}}`

**Duplicate handling:**
- If http_code is 409 OR `$result['data']['message']` contains 'duplicate key': return HTTP 409 with `{"ok": false, "message": "אימייל או מספר זהות כבר קיים במערכת"}`
- Other errors: return HTTP 500 with `{"ok": false, "message": "שגיאה ביצירת המשתמש"}`

**All `json_encode()` calls use `JSON_UNESCAPED_UNICODE` flag.**

No closing `?>` tag.
  </action>
  <verify>
Test with curl (after deploy or locally):

1. Valid user creation:
```
curl -s -X POST https://ch-ah.info/FirstApp/api/users/create.php \
  -H "Content-Type: application/json" \
  -d '{"first_name":"Test","last_name":"User","id_number":"123456789","phone":"0526804680","gender":"male","foreign_worker":false,"email":"test@example.com","password":"Password123"}'
```
Expected: HTTP 201, `{"ok":true,"user":{...}}` with NO password_hash field in response

2. Invalid email:
```
curl -s -X POST https://ch-ah.info/FirstApp/api/users/create.php \
  -H "Content-Type: application/json" \
  -d '{"first_name":"Test","last_name":"User","id_number":"123456789","phone":"0526804680","gender":"male","foreign_worker":false,"email":"not-an-email","password":"Password123"}'
```
Expected: HTTP 422, `{"ok":false,"message":"כתובת אימייל לא תקינה"}`

3. Short password:
```
curl -s -X POST https://ch-ah.info/FirstApp/api/users/create.php \
  -H "Content-Type: application/json" \
  -d '{"first_name":"Test","last_name":"User","id_number":"123456789","phone":"0526804680","gender":"male","foreign_worker":false,"email":"test2@example.com","password":"short"}'
```
Expected: HTTP 422, `{"ok":false,"message":"הסיסמא חייבת לכלול לפחות 8 תווים"}`

Also verify PHP syntax: `php -l api/users/create.php`
  </verify>
  <done>api/users/create.php exists, validates all fields server-side, hashes password with bcrypt, inserts into Supabase, returns created user without password_hash, and rejects invalid input with appropriate Hebrew error messages and HTTP status codes</done>
</task>

</tasks>

<verification>
- Both files exist under `api/users/`
- Both use `__DIR__ . '/../config.php'` and `__DIR__ . '/../supabase.php'` (NOT relative paths)
- `list.php` returns `{"ok":true,"users":[]}` for empty table
- `create.php` validates email (ADMIN-03), password length (ADMIN-04), required fields, gender whitelist, phone digits
- `create.php` uses `password_hash()` with `PASSWORD_DEFAULT` (ADMIN-04 backend)
- `create.php` uses `Prefer: return=representation` (4th arg true)
- `create.php` runs `unset($created['password_hash'])` before returning
- All `json_encode()` calls include `JSON_UNESCAPED_UNICODE`
- No closing `?>` tags
- No `password_hash` in list.php select query
</verification>

<success_criteria>
Both API endpoints return correct JSON responses when called with curl. list.php returns users array, create.php validates input and creates users with bcrypt-hashed passwords in Supabase. No password hashes are ever exposed in API responses.
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-read-and-create/04-01-SUMMARY.md`
</output>
