---
phase: 06-login-replacement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [api/login.php, index.html, api/config.php]
autonomous: false

must_haves:
  truths:
    - "Login page shows email field with Hebrew label instead of username field"
    - "Active user can log in with Supabase email+password and reach the dispatch page"
    - "PHP session persists across page refresh after login"
    - "Blocked user is refused login with a generic Hebrew error"
    - "Suspended user with future date is refused login; past date allows login"
    - "Hardcoded sharonb/1532 credentials no longer work"
  artifacts:
    - path: "api/login.php"
      provides: "Supabase-backed login with email lookup, bcrypt verify, status enforcement"
      contains: "password_verify"
    - path: "index.html"
      provides: "Email login form with Hebrew labels"
      contains: "type=\"email\" id=\"email\""
    - path: "api/config.php"
      provides: "Credentials file without ADMIN_USER/ADMIN_PASS constants"
  key_links:
    - from: "index.html"
      to: "api/login.php"
      via: "fetch POST with {email, password} JSON body"
      pattern: "email.*password"
    - from: "api/login.php"
      to: "api/supabase.php"
      via: "supabase_request GET /users?email=eq.X"
      pattern: "supabase_request.*GET.*email=eq"
    - from: "api/login.php"
      to: "PHP session"
      via: "session_regenerate_id then $_SESSION['logged_in'] = true"
      pattern: "session_regenerate_id.*logged_in.*true"
---

<objective>
Replace the hardcoded credential login with Supabase-backed email+password authentication including status enforcement (active/blocked/suspended).

Purpose: This is the final Phase of v2.0 — after this, every login is validated against the real user database. The hardcoded sharonb/1532 credentials are removed permanently.
Output: Modified `api/login.php`, `index.html`, and `api/config.php` — no new files.
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-login-replacement/06-RESEARCH.md
@api/login.php
@api/config.php
@api/supabase.php
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace login.php, update index.html email field, remove hardcoded credentials</name>
  <files>api/login.php, index.html, api/config.php</files>
  <action>
**1. Rewrite `api/login.php`** — replace the entire file with Supabase-backed authentication:

- Keep `session_start()` as the first call, keep `require_once __DIR__ . '/config.php'`
- Add `require_once __DIR__ . '/supabase.php'` (needed for `supabase_request()`)
- Read `email` and `password` from JSON body (replaces `username`)
- Define a single generic Hebrew error: `'פרטי הכניסה שגויים'` (used for ALL auth failures — never reveal which step failed)
- Guard: reject empty email or password immediately (no Supabase call)
- Guard: `filter_var($email, FILTER_VALIDATE_EMAIL)` — reject malformed email before Supabase call
- Fetch user: `supabase_request('GET', '/users?email=eq.' . rawurlencode($email) . '&select=id,email,status,suspended_until,password_hash')`
- Handle Supabase transport error (`$result['error'] !== null || $result['http_code'] !== 200`): return HTTP 500 with `'שגיאת שרת — נסה שוב'`
- Handle no user found (`empty($result['data'])`): return HTTP 401 with generic error
- `password_verify($password, $user['password_hash'])`: if false, return HTTP 401 with generic error
- Status enforcement:
  - `'blocked'` → return 401 with generic error
  - `'suspended'` → check `suspended_until`: if not null AND `new DateTime($suspendedUntil) > new DateTime('today', new DateTimeZone('UTC'))` → return 401; otherwise fall through (suspension expired)
  - `'active'` → fall through to login success
- Login success: `session_regenerate_id(true)` FIRST, then `$_SESSION['logged_in'] = true` and `$_SESSION['user'] = $user['email']`
- Return `{'ok': true}`
- Use `JSON_UNESCAPED_UNICODE` flag on all `json_encode` calls (Hebrew-safe)
- Do NOT include a closing `?>` tag

Follow the exact code structure from 06-RESEARCH.md Pattern 1 (the full example is there).

**2. Update `index.html` login form** — change the username field to email:

- Change `<label for="username">שם משתמש</label>` to `<label for="email">אימייל</label>`
- Change `<input type="text" id="username" name="username" placeholder="שם משתמש" autocomplete="username" required>` to `<input type="email" id="email" name="email" placeholder="אימייל" autocomplete="email" required>`
- In the JS submit handler: change `var username = document.getElementById('username').value;` to `var email = document.getElementById('email').value;`
- In the fetch body: change `JSON.stringify({ username: username, password: password })` to `JSON.stringify({ email: email, password: password })`
- Keep everything else unchanged — same error display, same DOMContentLoaded session check, same `.then()` chain pattern

**3. Remove hardcoded credentials from `api/config.php`**:

- Delete the two lines: `define('ADMIN_USER', 'Sharonb');` and `define('ADMIN_PASS', '1532');`
- Delete the comment above them: `// Admin login credentials — single hardcoded user for this learning project`
- Keep all other constants (MICROPAY_TOKEN, ADMIN_PHONE, BASE_URL, SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)

**4. Verify cleanup** — run grep to confirm no references to ADMIN_USER or ADMIN_PASS remain:

```bash
grep -r "ADMIN_USER\|ADMIN_PASS" api/ index.html
```

This must return zero results.
  </action>
  <verify>
1. `grep -r "ADMIN_USER\|ADMIN_PASS" api/ index.html` returns no results
2. `grep "supabase_request" api/login.php` returns a match (proves Supabase lookup is wired)
3. `grep "password_verify" api/login.php` returns a match (proves bcrypt check is present)
4. `grep 'id="email"' index.html` returns a match (proves field renamed)
5. `grep "username" index.html` returns NO match (proves old field fully removed)
6. `grep "filter_var" api/login.php` returns a match (proves email validation guard)
  </verify>
  <done>
api/login.php fetches user by email from Supabase, verifies bcrypt password, enforces active/blocked/suspended status, and sets PHP session on success. index.html sends email+password (not username+password). config.php no longer contains ADMIN_USER or ADMIN_PASS.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify login replacement works end-to-end at ch-ah.info</name>
  <action>
Human verification of the deployed login replacement at ch-ah.info. Wait for GitHub Actions deploy to complete, then test the 5 required checks below.
  </action>
  <what-built>Supabase-backed login replacing hardcoded credentials. Login form now uses email field. Status enforcement (active/blocked/suspended) implemented.</what-built>
  <how-to-verify>
**Pre-requisite:** You need the email and plaintext password of at least one active user in Supabase. If you do not remember the password, create a new test user via admin.php at https://ch-ah.info/FirstApp/admin.php first.

After the GitHub Actions deploy completes:

1. **Open** https://ch-ah.info/FirstApp/ — confirm the login form shows "אימייל" label (not "שם משתמש")
2. **Try old credentials** — enter `Sharonb` as email and `1532` as password → should fail with "פרטי הכניסה שגויים"
3. **Try wrong password** — enter a valid Supabase user email with a wrong password → should fail with "פרטי הכניסה שגויים"
4. **Try correct credentials** — enter a valid active user's email and correct password → should redirect to dashboard.html
5. **Refresh the page** — visit https://ch-ah.info/FirstApp/ again → should auto-redirect to dashboard (session persists)
6. **(Optional)** If you have a blocked user: try their credentials → should fail with "פרטי הכניסה שגויים"
7. **(Optional)** If you have a suspended user with a future date: try their credentials → should fail with "פרטי הכניסה שגויים"

All 5 required checks (points 1-5) must pass. Points 6-7 are optional but recommended.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 6 is complete when:
- The login form shows email (not username)
- Active Supabase users can log in
- Blocked/suspended users cannot log in
- Sessions persist across refresh
- Hardcoded sharonb/1532 credentials are gone from the codebase
- `grep -r "ADMIN_USER\|ADMIN_PASS" api/` returns nothing
</verification>

<success_criteria>
1. Login page at ch-ah.info/FirstApp/ shows email field with Hebrew label "אימייל"
2. Active user logs in successfully and reaches dashboard.html
3. Session persists across page refresh (auto-redirect on revisit)
4. Old hardcoded credentials (Sharonb/1532) are rejected
5. No reference to ADMIN_USER or ADMIN_PASS exists in the codebase
</success_criteria>

<output>
After completion, create `.planning/phases/06-login-replacement/06-01-SUMMARY.md`
</output>
