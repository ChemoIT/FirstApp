---
phase: 01-foundation-auth-dispatch
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - index.html
  - api/login.php
  - api/check-session.php
autonomous: true

must_haves:
  truths:
    - "Sharon sees a Hebrew login form when visiting ch-ah.info/FirstApp/"
    - "Entering wrong credentials shows the Hebrew error message on the same page without a redirect"
    - "Entering Sharonb / 1532 redirects to dashboard.html"
    - "After login, refreshing dashboard.html does not redirect back to login"
    - "Visiting dashboard.html URL directly without a session redirects back to index.html"
  artifacts:
    - path: "index.html"
      provides: "Hebrew RTL login form with JS fetch to api/login.php"
      contains: "login-form"
    - path: "api/login.php"
      provides: "Session-based auth endpoint reading JSON body"
      contains: "session_regenerate_id"
    - path: "api/check-session.php"
      provides: "Session status check endpoint for client-side redirect"
      contains: "session_start"
  key_links:
    - from: "index.html"
      to: "api/login.php"
      via: "fetch POST with JSON body {username, password}"
      pattern: "fetch.*api/login\\.php"
    - from: "index.html"
      to: "api/check-session.php"
      via: "fetch GET on DOMContentLoaded to auto-redirect if already logged in"
      pattern: "fetch.*api/check-session\\.php"
    - from: "api/login.php"
      to: "api/config.php"
      via: "require_once __DIR__ . '/config.php' for ADMIN_USER and ADMIN_PASS"
      pattern: "require_once.*config\\.php"
---

<objective>
Build the Hebrew login page and PHP session authentication — the entry point to the app and the security gate for everything behind it.

Purpose: This is the front door. Sharon must be able to log in with Sharonb/1532, see a clear Hebrew error for bad credentials, and have her session survive page refreshes. All protected pages (dashboard, future endpoints) depend on this session mechanism.

Output: 3 files — index.html (login form), api/login.php (credential validation + session creation), api/check-session.php (session status check for client-side guards).
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth-dispatch/01-RESEARCH.md
@.planning/phases/01-foundation-auth-dispatch/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api/login.php and api/check-session.php PHP endpoints</name>
  <files>api/login.php, api/check-session.php</files>
  <action>
Create `api/login.php` following research Pattern 3 (Login with Session Regeneration):

1. First line: `<?php` (no BOM, no whitespace before it)
2. Immediately call `session_start();`
3. `require_once __DIR__ . '/config.php';` to access ADMIN_USER and ADMIN_PASS
4. Set header: `Content-Type: application/json; charset=utf-8`
5. Read JSON body from `php://input` (NOT `$_POST` — research Pitfall 4): `$body = json_decode(file_get_contents('php://input'), true);`
6. Extract `$username = $body['username'] ?? '';` and `$password = $body['password'] ?? '';`
7. Compare against `ADMIN_USER` and `ADMIN_PASS` constants using strict `===`
8. On success:
   - Call `session_regenerate_id(true);` BEFORE setting session data (prevents session fixation — research)
   - Set `$_SESSION['logged_in'] = true;` and `$_SESSION['user'] = $username;`
   - Return `json_encode(['ok' => true])`
9. On failure:
   - Set `http_response_code(401);`
   - Return `json_encode(['ok' => false, 'message' => 'שם כניסה או סיסמא לא תקינים'])` (AUTH-02 Hebrew error)
10. No closing `?>` tag

Create `api/check-session.php` following research Pattern 4:

1. First line: `<?php`
2. `session_start();`
3. Set header: `Content-Type: application/json; charset=utf-8`
4. Return JSON: `['ok' => isset($_SESSION['logged_in']) && $_SESSION['logged_in'] === true]`
5. No closing `?>` tag

Both files must have `<?php` as the absolute first characters — no BOM, no blank line, nothing before it (research Pitfall 2).
  </action>
  <verify>
Check that:
- `api/login.php` contains `session_start()`, `session_regenerate_id(true)`, `php://input`, `ADMIN_USER`, `ADMIN_PASS`, and the Hebrew error string
- `api/check-session.php` contains `session_start()` and returns JSON with `ok` key
- Neither file contains a closing `?>` tag
- Both files start with `<?php` as the very first characters
  </verify>
  <done>api/login.php validates credentials against config constants, regenerates session ID on success, returns Hebrew error on failure. api/check-session.php returns session status as JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Create index.html Hebrew login page with fetch-based auth</name>
  <files>index.html</files>
  <action>
Create `index.html` as the login page — this is the default page when visiting `ch-ah.info/FirstApp/`.

HTML structure (research RTL Hebrew HTML Base):
- `<!DOCTYPE html>`, `<html lang="he" dir="rtl">`
- `<meta charset="UTF-8">`, `<meta name="viewport" content="width=device-width, initial-scale=1.0">`
- `<title>כניסה</title>` (Hebrew: "Login")
- Link to `css/style.css`

Body content:
- Container div with class for centering
- Heading: `<h1>כניסה למערכת</h1>` (Hebrew: "System Login")
- Login form with `id="login-form"`:
  - Label + input for username (`id="username"`, `type="text"`, `placeholder="שם משתמש"`, `autocomplete="username"`, `required`)
  - Label + input for password (`id="password"`, `type="password"`, `placeholder="סיסמא"`, `autocomplete="current-password"`, `required`)
  - Submit button: `<button type="submit">כניסה</button>` (Hebrew: "Login")
- Error message div: `<div id="error-msg" style="display:none;"></div>` (styled via CSS for red text)

JavaScript (inline `<script>` at bottom of body):

1. **On DOMContentLoaded:** Call `fetch('api/check-session.php')` — if already logged in (`data.ok === true`), redirect immediately to `dashboard.html`. This handles the case where Sharon is already logged in and navigates to the login page.

2. **On form submit** (research Code Example — Login Form POST with Fetch):
   - `e.preventDefault()`
   - Get username and password values from inputs
   - `fetch('api/login.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) })`
   - Parse JSON response
   - If `data.ok === true`: `window.location.href = 'dashboard.html'`
   - If not: display `data.message` in the `#error-msg` div (set `textContent` and `style.display = 'block'`)
   - Wrap fetch in try/catch — on network error, show a generic Hebrew error message in the error div: `"שגיאת תקשורת — נסה שוב"` (Communication error — try again)

No external JS libraries. No build step. Vanilla JS only.
  </action>
  <verify>
Check that:
- `index.html` has `lang="he"` and `dir="rtl"` on the html element
- Form has `id="login-form"` with username and password inputs
- JS calls `fetch('api/login.php')` with POST method and JSON body
- JS calls `fetch('api/check-session.php')` on page load
- Error message div has `id="error-msg"`
- On success, JS redirects to `dashboard.html`
- On failure, JS displays the server's Hebrew error message
  </verify>
  <done>index.html shows a Hebrew RTL login form. Valid login (Sharonb/1532) redirects to dashboard.html. Invalid login shows "שם כניסה או סיסמא לא תקינים" on the same page. Already-logged-in users are auto-redirected to dashboard.</done>
</task>

</tasks>

<verification>
After both tasks, verify against Phase 1 Success Criteria 1-4:
1. index.html exists and is the default page (Hebrew login form visible)
2. api/login.php returns 401 with Hebrew error for wrong credentials (AUTH-02)
3. api/login.php creates a session for correct credentials that survives refresh (AUTH-01, AUTH-03)
4. api/check-session.php enables client-side redirect for unauthorized access (AUTH-04)

Requirement coverage:
- AUTH-01: login.php validates Sharonb / 1532
- AUTH-02: login.php returns Hebrew error "שם כניסה או סיסמא לא תקינים"
- AUTH-03: PHP session persists across refresh (session_start in check-session.php)
- AUTH-04: check-session.php + JS redirect in dashboard.html (dashboard redirect is wired in Plan 01-03, but the endpoint exists here)
</verification>

<success_criteria>
- index.html renders a Hebrew RTL login form
- POST to api/login.php with correct creds returns `{"ok": true}` and creates a session
- POST to api/login.php with wrong creds returns 401 with `{"ok": false, "message": "שם כניסה או סיסמא לא תקינים"}`
- GET to api/check-session.php returns `{"ok": true}` when session exists, `{"ok": false}` when not
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth-dispatch/01-02-SUMMARY.md`
</output>
