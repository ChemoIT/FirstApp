---
phase: 01-foundation-auth-dispatch
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - dashboard.html
  - api/send-sms.php
autonomous: false

must_haves:
  truths:
    - "After logging in, Sharon sees the dispatch page with Hebrew title and a dispatch button"
    - "Visiting dashboard.html without a session redirects back to index.html"
    - "Clicking the dispatch button sends an SMS to 0526804680 with Hebrew message and signing link"
    - "Sharon sees success or error feedback on the page after clicking dispatch"
    - "The SMS arrives on the phone with the message and link"
  artifacts:
    - path: "dashboard.html"
      provides: "Protected dispatch page with Hebrew UI and session guard"
      contains: "דף שיגור חתימה"
    - path: "api/send-sms.php"
      provides: "SMS dispatch endpoint using cURL to Micropay API"
      contains: "curl_init"
  key_links:
    - from: "dashboard.html"
      to: "api/check-session.php"
      via: "fetch GET on DOMContentLoaded — redirects to index.html if not logged in"
      pattern: "fetch.*api/check-session\\.php"
    - from: "dashboard.html"
      to: "api/send-sms.php"
      via: "fetch POST on dispatch button click"
      pattern: "fetch.*api/send-sms\\.php"
    - from: "api/send-sms.php"
      to: "api/config.php"
      via: "require_once for MICROPAY_TOKEN, ADMIN_PHONE, BASE_URL"
      pattern: "require_once.*config\\.php"
    - from: "api/send-sms.php"
      to: "http://www.micropay.co.il/ExtApi/ScheduleSms.php"
      via: "cURL GET request with token and Hebrew message"
      pattern: "curl_init"
---

<objective>
Build the protected dispatch page and SMS send endpoint — the final piece of Phase 1 that completes Sharon's side of the signing loop.

Purpose: After logging in, Sharon lands on this page and can dispatch a signing request via SMS with one click. This plan wires together authentication (from Plan 01-02), configuration (from Plan 01-01), and the Micropay SMS API into a working dispatch flow. The human-verify checkpoint confirms the SMS actually arrives on the phone.

Output: 2 files — dashboard.html (protected dispatch UI), api/send-sms.php (session-guarded SMS endpoint using cURL to Micropay).
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth-dispatch/01-RESEARCH.md
@.planning/phases/01-foundation-auth-dispatch/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth-dispatch/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api/send-sms.php with session guard and Micropay cURL call</name>
  <files>api/send-sms.php</files>
  <action>
Create `api/send-sms.php` following research Patterns 2 (auth guard) and 5 (Micropay cURL call):

1. First line: `<?php` (no BOM, no whitespace)
2. `session_start();`
3. Auth guard (research Pattern 2 — copy exactly):
   ```php
   if (!isset($_SESSION['logged_in']) || $_SESSION['logged_in'] !== true) {
       http_response_code(401);
       header('Content-Type: application/json; charset=utf-8');
       echo json_encode(['ok' => false, 'message' => 'Unauthorized']);
       exit;
   }
   ```
4. `require_once __DIR__ . '/config.php';`
5. Set header: `Content-Type: application/json; charset=utf-8`
6. Build the SMS:
   - `$phone = ADMIN_PHONE;` (from config: '0526804680')
   - `$signUrl = BASE_URL . '/sign.html';` (signing page link for Phase 2)
   - `$messageUtf8 = 'היכנס לקישור הבא: ' . $signUrl;` (DISP-03 exact Hebrew message)
   - Convert encoding: `$messageEncoded = iconv('UTF-8', 'ISO-8859-8', $messageUtf8);` (research — required for Hebrew SMS)
7. Build Micropay API URL with `http_build_query()`:
   - `get` = `'1'`
   - `token` = `MICROPAY_TOKEN`
   - `msg` = `$messageEncoded`
   - `list` = `$phone`
   - `charset` = `'iso-8859-8'`
   - `from` = `'Chemo IT'`
   - Endpoint: `'http://www.micropay.co.il/ExtApi/ScheduleSms.php?' . $params`
8. Make cURL call (research — use cURL, NOT file_get_contents):
   - `curl_init($url)`
   - `CURLOPT_RETURNTRANSFER` = `true`
   - `CURLOPT_TIMEOUT` = `10`
   - Execute, capture result and error, close handle
9. Error handling:
   - If `curl_error($ch)` is non-empty: return 500 with `['ok' => false, 'message' => 'שגיאה בשליחת SMS: ' . $error]`
   - Otherwise: return `['ok' => true, 'result' => $result]` (include raw Micropay response for debugging — research notes response format is not fully documented)
10. No closing `?>` tag
  </action>
  <verify>
Check that:
- `api/send-sms.php` starts with `<?php` then `session_start()`
- Contains auth guard checking `$_SESSION['logged_in']`
- Contains `require_once __DIR__ . '/config.php'`
- Uses `iconv('UTF-8', 'ISO-8859-8', ...)` for Hebrew encoding
- Uses `curl_init` (NOT `file_get_contents`) for the API call
- Builds URL with `http_build_query` including all 6 Micropay parameters
- Returns JSON with `ok` key in all code paths (success, curl error, unauthorized)
- Does NOT contain closing `?>` tag
  </verify>
  <done>api/send-sms.php guards with session check, builds Hebrew SMS with correct encoding, calls Micropay API via cURL, returns JSON success/error to client.</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard.html protected dispatch page with session guard and SMS dispatch UI</name>
  <files>dashboard.html</files>
  <action>
Create `dashboard.html` as the protected dispatch page Sharon sees after login.

HTML structure:
- `<!DOCTYPE html>`, `<html lang="he" dir="rtl">`
- `<meta charset="UTF-8">`, `<meta name="viewport" content="width=device-width, initial-scale=1.0">`
- `<title>דף שיגור חתימה</title>` (Hebrew: "Signature Dispatch Page")
- Link to `css/style.css`

Body content:
- Container div with class for centering
- Heading: `<h1>דף שיגור חתימה</h1>` (DISP-01: Hebrew title)
- Brief instruction text: `<p>לחץ על הכפתור לשליחת SMS עם קישור חתימה</p>` (Hebrew: "Click the button to send SMS with signing link")
- Dispatch button: `<button id="dispatch-btn">שלח בקשת חתימה</button>` (Hebrew: "Send Signature Request")
- Status/feedback div: `<div id="status-msg" style="display:none;"></div>` — used for both success (green) and error (red) feedback (DISP-04)
- Logout link at bottom: `<a href="#" id="logout-link">יציאה</a>` (Hebrew: "Logout") — for future use, currently clears client state

JavaScript (inline `<script>` at bottom of body):

1. **Session guard on DOMContentLoaded** (research Pattern 4):
   - `fetch('api/check-session.php')` — if `data.ok` is not `true`, redirect to `index.html`
   - This handles AUTH-04: unauthorized access redirects to login

2. **Dispatch button click handler:**
   - Disable the button during the request (prevent double-click)
   - Set button text to `"שולח..."` (Hebrew: "Sending...") during request
   - `fetch('api/send-sms.php', { method: 'POST', headers: { 'Content-Type': 'application/json' } })`
   - Parse JSON response
   - If `data.ok === true`:
     - Show success message in `#status-msg`: `"SMS נשלח בהצלחה!"` (Hebrew: "SMS sent successfully!")
     - Apply success styling (green text — use a CSS class like `.success`)
   - If `data.ok === false`:
     - Show error message in `#status-msg`: the server's error message (`data.message`)
     - Apply error styling (red text — use a CSS class like `.error`)
   - Re-enable the button and restore original text after response
   - Wrap fetch in try/catch — on network error, show `"שגיאת תקשורת — נסה שוב"` (Communication error — try again)

3. **Logout link handler** (simple for now):
   - On click, redirect to `index.html` (session will still exist server-side, but this provides basic UX — full server-side logout is a v2 concern)

No external JS libraries. Vanilla JS only.
  </action>
  <verify>
Check that:
- `dashboard.html` has `lang="he"` and `dir="rtl"` on html element
- Contains `<h1>דף שיגור חתימה</h1>` (DISP-01)
- JS calls `fetch('api/check-session.php')` on load and redirects to `index.html` if not authenticated
- Dispatch button calls `fetch('api/send-sms.php')` with POST
- Success feedback shows in `#status-msg` div (DISP-04)
- Error feedback shows in `#status-msg` div (DISP-04)
- Button is disabled during request to prevent double-send
  </verify>
  <done>dashboard.html shows Hebrew dispatch page with session guard redirect. Dispatch button calls send-sms.php, shows success/error feedback. Unauthorized visitors are redirected to login.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full login-to-SMS flow works end-to-end</name>
  <files>None — verification only</files>
  <action>
WHAT WAS BUILT: Complete Phase 1 — login form, session auth, protected dispatch page, SMS dispatch to phone via Micropay API. All code is ready to push to GitHub (ChemoIT/FirstApp) and deploy to ch-ah.info/FirstApp/.

Push code to GitHub and deploy to ch-ah.info/FirstApp/ via FTP. Then verify the 6 checks below.
  </action>
  <verify>
After code is pushed and deployed to ch-ah.info/FirstApp/:

1. **Login page**: Open https://ch-ah.info/FirstApp/ in a browser. You should see a Hebrew login form with "כניסה למערכת" heading.

2. **Wrong credentials**: Enter username "test" and password "wrong", click login. You should see the Hebrew error "שם כניסה או סיסמא לא תקינים" in red.

3. **Correct login**: Enter username "Sharonb" and password "1532", click login. You should be redirected to the dispatch page showing "דף שיגור חתימה".

4. **Session persistence**: Refresh the dispatch page (F5). You should still be on the dispatch page — not redirected back to login.

5. **Auth protection**: Open a new private/incognito browser window. Navigate directly to https://ch-ah.info/FirstApp/dashboard.html. You should be redirected to the login page.

6. **SMS dispatch**: Back in the logged-in window, click the "שלח בקשת חתימה" button. You should see either a success message or an error. Check phone 0526804680 — an SMS should arrive with Hebrew text "היכנס לקישור הבא:" followed by the signing link.
  </verify>
  <done>All 6 verification checks pass: login form visible, wrong creds show Hebrew error, correct creds reach dispatch page, session survives refresh, unauthorized access redirects to login, SMS arrives on phone. Type "approved" if all pass, or describe which steps failed.</done>
</task>

</tasks>

<verification>
Phase 1 Success Criteria (from ROADMAP.md):
1. Sharon visits ch-ah.info/FirstApp/ and sees the Hebrew login form — verified by index.html existence
2. Entering wrong credentials shows "שם כניסה או סיסמא לא תקינים" — verified by api/login.php 401 response
3. Entering Sharonb / 1532 reaches dispatch page and session survives refresh — verified by session_start + check-session.php
4. Visiting dispatch page URL without login redirects to login — verified by dashboard.html JS guard + check-session.php
5. Clicking dispatch sends SMS to 0526804680 — verified by human checkpoint

Requirement coverage for this plan:
- DISP-01: dashboard.html shows "דף שיגור חתימה" with dispatch button
- DISP-02: send-sms.php sends SMS to 0526804680 with signing link
- DISP-03: SMS message is Hebrew "היכנס לקישור הבא:" followed by URL
- DISP-04: Success/error feedback shown after dispatch attempt
</verification>

<success_criteria>
- dashboard.html shows Hebrew dispatch page with session guard
- api/send-sms.php sends SMS via Micropay cURL when called by authenticated user
- api/send-sms.php returns 401 when called without session
- Human verifies SMS arrives on phone 0526804680
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth-dispatch/01-03-SUMMARY.md`
</output>
