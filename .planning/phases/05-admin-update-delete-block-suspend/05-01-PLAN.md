---
phase: 05-admin-update-delete-block-suspend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/users/update.php
  - api/users/delete.php
autonomous: true

must_haves:
  truths:
    - "POST to api/users/update.php with action=edit updates user fields in Supabase and returns ok:true"
    - "POST to api/users/update.php with action=block sets status to blocked and clears suspended_until"
    - "POST to api/users/update.php with action=suspend sets status to suspended and stores a future date"
    - "POST to api/users/update.php with a past suspend date returns 422 with Hebrew error"
    - "POST to api/users/delete.php with a valid id removes the user from Supabase and returns ok:true"
    - "DELETE checks for http_code 204 (not 200) from Supabase"
  artifacts:
    - path: "api/users/update.php"
      provides: "PATCH endpoint for edit, block, and suspend actions"
      contains: "supabase_request('PATCH'"
    - path: "api/users/delete.php"
      provides: "DELETE endpoint for removing users"
      contains: "supabase_request('DELETE'"
  key_links:
    - from: "api/users/update.php"
      to: "api/supabase.php"
      via: "supabase_request('PATCH', '/users?id=eq.')"
      pattern: "supabase_request\\('PATCH'"
    - from: "api/users/delete.php"
      to: "api/supabase.php"
      via: "supabase_request('DELETE', '/users?id=eq.')"
      pattern: "supabase_request\\('DELETE'"
---

<objective>
Create the two PHP API endpoints that power all Phase 5 admin actions: update.php (handles edit/block/suspend via a single PATCH endpoint with action dispatching) and delete.php (handles user removal via DELETE).

Purpose: The admin.php UI (Plan 05-02) needs backend endpoints to call. These endpoints translate browser POST requests into Supabase PATCH/DELETE operations using the existing supabase_request() helper from Phase 3.

Output: Two new PHP files in api/users/ — ready for admin.php to consume via fetch().
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-update-delete-block-suspend/05-RESEARCH.md

# Source files to reference for established patterns
@api/supabase.php
@api/users/create.php
@api/users/list.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api/users/update.php — PATCH endpoint for edit, block, and suspend</name>
  <files>api/users/update.php</files>
  <action>
Create `api/users/update.php` following the exact pattern from RESEARCH.md Pattern 3.

The endpoint accepts POST with JSON body containing `id` (integer), `action` (string: "edit"|"block"|"suspend"), and action-specific fields.

Structure (follow create.php patterns exactly):
1. `require_once __DIR__ . '/../config.php'` and `require_once __DIR__ . '/../supabase.php'` — one level up, same as create.php
2. `header('Content-Type: application/json; charset=utf-8')`
3. Reject non-POST with 405
4. Read JSON body via `php://input`, extract `id` via `intval()`, extract `action`
5. Validate `$userId > 0` — return 422 with `מזהה משתמש לא תקין`
6. Dispatch on `$action`:

   **"edit" action:**
   - Extract and trim: first_name, last_name, phone, email, gender
   - Extract foreign_worker as (bool)
   - Validate all required fields non-empty — return 422 `כל השדות חובה`
   - Validate email with `filter_var(FILTER_VALIDATE_EMAIL)` — return 422 `כתובת אימייל לא תקינה`
   - Validate phone with `preg_match('/^\d+$/')` — return 422 `מספר טלפון חייב לכלול ספרות בלבד`
   - Validate gender with `in_array(['male','female'], true)` — return 422 `ערך מגדר לא תקין`
   - Build $patch array with all 6 fields
   - NOTE: Do NOT include id_number in edit — identity docs should not change after creation (per RESEARCH.md Open Question 1)

   **"block" action:**
   - $patch = ['status' => 'blocked', 'suspended_until' => null]
   - CRITICAL: Must set suspended_until to null to clear any previous suspend date (Pitfall 6 from RESEARCH.md)

   **"suspend" action:**
   - Extract suspended_until from body, trim
   - Validate date format with `DateTime::createFromFormat('Y-m-d', $suspendedUntil)` — return 422 `תאריך לא תקין` if invalid
   - Validate future date: `$date <= new DateTime('today')` — return 422 `תאריך ההשעיה חייב להיות בעתיד`
   - $patch = ['status' => 'suspended', 'suspended_until' => $suspendedUntil]

   **Unknown action:** return 422 `פעולה לא תקינה`

7. Call `supabase_request('PATCH', '/users?id=eq.' . $userId, $patch)`
8. Check `$result['http_code'] !== 200` for error — return 500 `שגיאה בעדכון המשתמש`
9. Return 200 with `{"ok": true}`

All json_encode calls must include `JSON_UNESCAPED_UNICODE` flag (Hebrew-safe, per established pattern).
  </action>
  <verify>Run `php -l api/users/update.php` — must output "No syntax errors detected"</verify>
  <done>update.php exists, passes syntax check, handles all three actions (edit/block/suspend) with server-side validation, uses intval() on userId to prevent PostgREST injection, and clears suspended_until on block</done>
</task>

<task type="auto">
  <name>Task 2: Create api/users/delete.php — DELETE endpoint for removing users</name>
  <files>api/users/delete.php</files>
  <action>
Create `api/users/delete.php` following RESEARCH.md Pattern 4.

The endpoint accepts POST with JSON body containing `id` (integer).

Structure (follow create.php patterns exactly):
1. `require_once __DIR__ . '/../config.php'` and `require_once __DIR__ . '/../supabase.php'`
2. `header('Content-Type: application/json; charset=utf-8')`
3. Reject non-POST with 405
4. Read JSON body via `php://input`, extract `id` via `intval()`
5. Validate `$userId > 0` — return 422 with `מזהה משתמש לא תקין`
6. Call `supabase_request('DELETE', '/users?id=eq.' . $userId)` — no body, no third arg
7. CRITICAL: Check `$result['http_code'] !== 204` for error (NOT 200 — DELETE returns 204 No Content per Pitfall 1 from RESEARCH.md)
8. On error: return 500 with `שגיאה במחיקת המשתמש`
9. On success: return 200 with `{"ok": true}`

All json_encode calls must include `JSON_UNESCAPED_UNICODE` flag.
  </action>
  <verify>Run `php -l api/users/delete.php` — must output "No syntax errors detected"</verify>
  <done>delete.php exists, passes syntax check, sends DELETE to Supabase, checks for http_code 204 (not 200), and returns ok:true on success</done>
</task>

</tasks>

<verification>
1. `php -l api/users/update.php` — no syntax errors
2. `php -l api/users/delete.php` — no syntax errors
3. Both files use `__DIR__ . '/../'` for require_once (same as create.php)
4. update.php handles edit, block, and suspend actions with proper validation
5. delete.php checks for HTTP 204 (not 200) on DELETE success
6. All Hebrew error messages use JSON_UNESCAPED_UNICODE
</verification>

<success_criteria>
Two new PHP files exist at api/users/update.php and api/users/delete.php. Both pass php -l syntax check. update.php dispatches on action field (edit validates 4 rules, block clears suspended_until, suspend validates future date). delete.php checks for 204 on DELETE success. Both follow the exact same require_once and response patterns as create.php.
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-update-delete-block-suspend/05-01-SUMMARY.md`
</output>
