---
phase: 05-admin-update-delete-block-suspend
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - admin.php
  - api/users/list.php
autonomous: false

must_haves:
  truths:
    - "Admin can click Edit on a user row, see a modal pre-populated with current values, change a field, save, and see the updated value in the table"
    - "Admin can click Delete on a user row, confirm in a browser dialog, and the user disappears from the table"
    - "Admin can click Block on a user row, confirm, and the status badge changes to blocked (red)"
    - "Admin can click Suspend on a user row, pick a future date in a modal, save, and the status shows suspended with the date"
    - "All action buttons have Hebrew labels and the page remains RTL"
    - "XSS is prevented — user data in data-* attributes and innerHTML is escaped via escHtml()"
  artifacts:
    - path: "admin.php"
      provides: "Edit modal, suspend modal, action buttons per row, event delegation, escHtml()"
      contains: "editModal"
    - path: "admin.php"
      provides: "updateUser() and deleteUser() fetch helpers"
      contains: "function updateUser"
    - path: "api/users/list.php"
      provides: "suspended_until field in SELECT query"
      contains: "suspended_until"
  key_links:
    - from: "admin.php"
      to: "api/users/update.php"
      via: "fetch('api/users/update.php') in updateUser()"
      pattern: "fetch.*api/users/update\\.php"
    - from: "admin.php"
      to: "api/users/delete.php"
      via: "fetch('api/users/delete.php') in deleteUser()"
      pattern: "fetch.*api/users/delete\\.php"
    - from: "admin.php loadUsers()"
      to: "api/users/list.php"
      via: "fetch('api/users/list.php') — already wired from Phase 4"
      pattern: "fetch.*api/users/list\\.php"
    - from: "admin.php tbody click"
      to: "event delegation handler"
      via: "addEventListener('click') on #users-tbody"
      pattern: "users-tbody.*addEventListener.*click"
---

<objective>
Add edit modal, delete confirmation, block button, and suspend-with-date-picker to admin.php — plus update list.php to return suspended_until so the table can display it.

Purpose: This completes Phase 5 by giving the admin full control over existing users. All four operations (edit, delete, block, suspend) are wired to the API endpoints created in Plan 05-01.

Output: Modified admin.php with action buttons per row, two modals (edit + suspend), event delegation on tbody, and JS fetch helpers. Modified list.php with suspended_until in SELECT.
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-update-delete-block-suspend/05-RESEARCH.md
@.planning/phases/05-admin-update-delete-block-suspend/05-01-SUMMARY.md

# Source files — must read before modifying
@admin.php
@api/users/list.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify list.php and admin.php — add suspended_until, action column, modals, and all JS handlers</name>
  <files>api/users/list.php, admin.php</files>
  <action>
**Part A: Modify api/users/list.php** — add `suspended_until` to the SELECT query.

Current SELECT string:
`select=id,first_name,last_name,id_number,email,phone,gender,foreign_worker,status,created_at`

Change to:
`select=id,first_name,last_name,id_number,email,phone,gender,foreign_worker,status,suspended_until,created_at`

This is the ONLY change to list.php. Do not change anything else.

---

**Part B: Modify admin.php** — extensive changes to HTML and JS sections. Read the current file first, then apply ALL of the following changes:

**B1. Add escHtml() function** (MANDATORY for XSS prevention — RESEARCH.md Pattern 5):
At the very top of the `<script>` block (before statusBadge), add:
```javascript
function escHtml(str) {
    return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}
```

**B2. Update statusBadge()** to display suspended_until date when status is 'suspended':
Change the suspended line from:
`if (status === 'suspended') return '<span class="badge bg-warning text-dark">מושעה</span>';`
To a version that accepts a second argument `suspendedUntil`:
```javascript
function statusBadge(status, suspendedUntil) {
    if (status === 'active')    return '<span class="badge bg-success">פעיל</span>';
    if (status === 'blocked')   return '<span class="badge bg-danger">חסום</span>';
    if (status === 'suspended') {
        var dateStr = '';
        if (suspendedUntil) {
            var d = new Date(suspendedUntil);
            dateStr = ' עד ' + d.toLocaleDateString('he-IL');
        }
        return '<span class="badge bg-warning text-dark">מושעה' + dateStr + '</span>';
    }
    return '<span class="badge bg-secondary">' + escHtml(status) + '</span>';
}
```

**B3. Update table header** — add an 8th column `<th>פעולות</th>` after the status column.

**B4. Update all colspan values** from "7" to "8" (loading row, error row, empty-state row in loadUsers).

**B5. Rewrite the loadUsers() forEach loop** to add action buttons and data-* attributes per row.
Replace the existing forEach with RESEARCH.md Pattern 5 code. Key points:
- Set `data-user-id` on each `<tr>`
- Add an 8th `<td>` with 4 buttons: btn-edit (עריכה), btn-delete (מחיקה), btn-block (חסימה), btn-suspend (השעיה)
- btn-edit carries data-id, data-first-name, data-last-name, data-phone, data-email, data-gender, data-foreign-worker — ALL values escaped with escHtml()
- btn-delete carries data-id and data-name (escaped full name)
- btn-block carries data-id only
- btn-suspend carries data-id only
- Pass `user.suspended_until` as second arg to `statusBadge(user.status, user.suspended_until)`
- Use escHtml() on ALL user data inserted into innerHTML (first_name, last_name, id_number, email, phone)

**B6. Add two modals BEFORE the closing `</div><!-- /container-lg -->` tag:**

1. **Edit modal** (`#editModal`) — RESEARCH.md Pattern 6. Fields: hidden edit-user-id, edit-first-name, edit-last-name, edit-phone, edit-email, edit-gender (select), edit-foreign-worker (checkbox). All labels in Hebrew. Footer: cancel (ביטול) + save (שמור) buttons. Include #edit-modal-error alert div.

2. **Suspend modal** (`#suspendModal`) — RESEARCH.md Pattern 6. Fields: hidden suspend-user-id, suspend-until (input type=date). Label: `השעה עד תאריך`. Footer: cancel (ביטול) + suspend (השעה) buttons. Include #suspend-modal-error alert div.

**B7. Add event delegation handler on #users-tbody** — RESEARCH.md Pattern 7.
Register ONE click handler on `document.getElementById('users-tbody')` using `e.target.closest('button')`.
Dispatch on classList:
- btn-edit: populate edit modal from data-* attributes, show with `bootstrap.Modal.getOrCreateInstance()`
- btn-delete: `window.confirm('האם למחוק את המשתמש ' + name + '?')` then call deleteUser(userId)
- btn-block: `window.confirm('האם לחסום את המשתמש?')` then call updateUser({id, action:'block'})
- btn-suspend: set suspend-user-id, set min date to tomorrow, clear value, show suspend modal

This handler must be registered ONCE (not inside loadUsers) — outside the DOMContentLoaded or inside it but NOT inside loadUsers. Event delegation on the stable tbody parent survives table re-renders.

**B8. Add updateUser(payload) function** — RESEARCH.md Pattern 8.
ES5 .then() chain. POST to 'api/users/update.php'. On success (data.ok): call loadUsers(). On failure: alert(data.message). On network error: alert Hebrew message.

**B9. Add deleteUser(userId) function** — RESEARCH.md Pattern 8.
ES5 .then() chain. POST to 'api/users/delete.php' with {id: userId}. On success (data.ok): call loadUsers(). On failure: alert(data.message). On network error: alert Hebrew message.

**B10. Add edit-save-btn click handler** — RESEARCH.md Pattern 9.
Gather values from edit modal fields. Client-side validation: all fields required (show error in #edit-modal-error if empty). Hide modal with getOrCreateInstance().hide(). Call updateUser(payload) with action:'edit'.

**B11. Add suspend-save-btn click handler:**
Read suspend-user-id and suspend-until values. Validate date is not empty (show error in #suspend-modal-error). Hide modal. Call updateUser({id, action:'suspend', suspended_until: dateValue}).

**IMPORTANT ordering notes:**
- escHtml() and statusBadge() must be defined BEFORE loadUsers() uses them
- updateUser() and deleteUser() must be defined BEFORE the event delegation handler uses them
- Modal save handlers can be defined anywhere (they are stable DOM, not re-rendered)
- The event delegation on #users-tbody must be registered AFTER DOMContentLoaded (the tbody must exist in DOM)
  </action>
  <verify>
1. Run `php -l admin.php` — no syntax errors
2. Run `php -l api/users/list.php` — no syntax errors
3. Grep for `escHtml` in admin.php — must find the function definition and multiple call sites
4. Grep for `editModal` in admin.php — must find the modal HTML
5. Grep for `suspendModal` in admin.php — must find the modal HTML
6. Grep for `suspended_until` in api/users/list.php — must appear in SELECT string
7. Grep for `getOrCreateInstance` in admin.php — must be used (not `new bootstrap.Modal`)
8. Grep for `users-tbody.*addEventListener` or `addEventListener.*click` near users-tbody — event delegation present
  </verify>
  <done>admin.php has action buttons in every row, edit modal, suspend modal, event delegation on tbody, escHtml() for XSS prevention, updateUser() and deleteUser() fetch helpers. list.php returns suspended_until. Status badge shows suspend date.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all four admin actions work end-to-end</name>
  <files>admin.php</files>
  <action>
CHECKPOINT — Human verification of all Phase 5 admin actions at https://ch-ah.info/FirstApp/admin.php

What was built: Complete admin CRUD — edit user details via modal, delete user with confirmation, block user (permanent), suspend user with future date picker. All actions call the API endpoints from Plan 05-01 and refresh the table automatically.

Verify all 8 points:

1. Table has action column: Each user row shows 4 buttons (עריכה, מחיקה, חסימה, השעיה)
2. Edit works: Click עריכה on a user. Modal opens with current values pre-filled. Change the phone number. Click שמור. The modal closes and the table refreshes with the new phone number visible.
3. Delete works: Click מחיקה on a user. Browser confirm dialog appears with the user's name. Click OK. The user disappears from the table. Verify in Supabase dashboard that the row is gone.
4. Block works: Click חסימה on a user. Browser confirm dialog appears. Click OK. The user's status badge changes to חסום (red). Verify in Supabase that status='blocked' and suspended_until is NULL.
5. Suspend works: Click השעיה on a user. Modal opens with a date picker. Select a future date. Click השעה. The status badge changes to מושעה with the date shown. Verify in Supabase that status='suspended' and suspended_until has the correct date.
6. Suspend validation: Try selecting today's date or a past date — the date picker should prevent it (min attribute set to tomorrow).
7. Search still works: Type a name in the search box — rows filter correctly including the new action column.
8. Hebrew RTL: All modal labels, button text, and error messages are in Hebrew. Layout is right-to-left.

Resume signal: Type "approved" or describe any issues.
  </action>
  <verify>Human opens https://ch-ah.info/FirstApp/admin.php and confirms all 8 verification points pass</verify>
  <done>All four admin operations (edit, delete, block, suspend) work end-to-end in production — confirmed by human tester</done>
</task>

</tasks>

<verification>
1. api/users/list.php includes `suspended_until` in SELECT query
2. admin.php has escHtml() defined and used on all user data in innerHTML
3. admin.php has editModal and suspendModal with Hebrew labels
4. admin.php uses event delegation on #users-tbody (not individual button listeners)
5. admin.php uses bootstrap.Modal.getOrCreateInstance() (not new bootstrap.Modal)
6. updateUser() calls api/users/update.php via POST
7. deleteUser() calls api/users/delete.php via POST
8. Status badge shows suspended_until date for suspended users
9. All four admin operations work end-to-end at ch-ah.info
</verification>

<success_criteria>
Admin can edit a user (modal with pre-populated fields, save updates the table), delete a user (confirm dialog, user disappears), block a user (status becomes blocked), and suspend a user (date picker, status shows suspended with date). All Hebrew, all RTL, no XSS vulnerabilities in data-* attributes.
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-update-delete-block-suspend/05-02-SUMMARY.md`
</output>
