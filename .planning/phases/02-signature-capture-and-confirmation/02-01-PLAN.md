---
phase: 02-signature-capture-and-confirmation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sign.html
  - api/save-signature.php
autonomous: true

must_haves:
  truths:
    - "Opening sign.html on a mobile phone shows Hebrew page with title 'חתום פה' and a touch-draw signature area"
    - "User can draw a signature with finger (touch) and with mouse (desktop)"
    - "User can clear and redraw the signature"
    - "Tapping 'שלח' on an empty canvas shows error 'אנא חתום לפני השליחה'"
    - "Tapping 'שלח' with a drawn signature saves a non-blank PNG to signatures/ folder"
    - "After PNG save, confirmation SMS 'המסמך נחתם' is sent to 0526804680"
    - "The signatures/ folder is not directly browsable (already protected by Phase 1 .htaccess)"
  artifacts:
    - path: "sign.html"
      provides: "Public Hebrew RTL signing page with signature_pad canvas"
      contains: "signature_pad@5.1.3"
    - path: "api/save-signature.php"
      provides: "Base64 PNG receive, GD validate, save, confirmation SMS"
      contains: "imagecreatefromstring"
  key_links:
    - from: "sign.html"
      to: "api/save-signature.php"
      via: "fetch POST with JSON body containing base64 data URL"
      pattern: "fetch.*api/save-signature\\.php"
    - from: "api/save-signature.php"
      to: "api/config.php"
      via: "require_once for MICROPAY_TOKEN, ADMIN_PHONE constants"
      pattern: "require_once.*config\\.php"
    - from: "api/save-signature.php"
      to: "signatures/"
      via: "imagepng() writes PNG file"
      pattern: "imagepng.*signatures/"
    - from: "api/save-signature.php"
      to: "Micropay API"
      via: "cURL GET identical to send-sms.php pattern"
      pattern: "micropay\\.co\\.il.*ScheduleSms"
---

<objective>
Create the recipient-facing signing page and server-side save endpoint — the two new files that complete the signature capture and confirmation loop.

Purpose: Phase 2 delivers the other half of the SMS signing flow. Phase 1 dispatches the SMS with a link to sign.html. This plan builds sign.html (public canvas page) and api/save-signature.php (receives the signature, saves PNG, sends confirmation SMS). After this plan, the full send-sign-confirm loop is functionally complete.

Output: sign.html (public signing page with signature_pad v5.1.3) and api/save-signature.php (base64 decode, GD validate, PNG save, Micropay confirmation SMS).
</objective>

<execution_context>
@C:/Users/Alias/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Alias/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-signature-capture-and-confirmation/02-RESEARCH.md
@api/config.php
@api/send-sms.php
@css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sign.html — public Hebrew signing page with signature_pad v5.1.3 canvas</name>
  <files>sign.html</files>
  <action>
Create sign.html in the project root (same level as index.html and dashboard.html). This is a PUBLIC page — no session auth, no redirect guard. The SMS link IS the authorization.

Page structure (Hebrew RTL, matches Phase 1 HTML pattern):
- DOCTYPE html, lang="he" dir="rtl", charset UTF-8
- viewport meta: width=device-width, initial-scale=1.0, user-scalable=no (prevents pinch-zoom interfering with drawing)
- Title: "חתום פה"
- Link to css/style.css (shared base styles from Phase 1)
- Inline style block for canvas-specific CSS (not in shared style.css):
  - #signature-canvas: border 2px solid #ccc, border-radius 4px, width 100%, height 200px, display block, cursor crosshair, touch-action: none (CRITICAL — prevents page scroll while drawing), background #fff
  - .btn-row: display flex, gap 12px, margin-top 16px
  - #clear-btn: background-color #757575, color #fff

Body structure:
- div.container > h1 "חתום פה"
- div#signing-area containing:
  - canvas#signature-canvas
  - div.btn-row with two buttons:
    - button#submit-btn.btn.btn-primary "שלח"
    - button#clear-btn.btn "נקה"
- div#status-msg.error-msg (hidden by default, uses shared .error-msg / .success-msg / .visible classes from style.css)

Scripts (at bottom of body):
1. CDN script tag: https://cdn.jsdelivr.net/npm/signature_pad@5.1.3/dist/signature_pad.umd.min.js
2. Inline script block with ALL of the following:

JavaScript (use var, not let/const — matches Phase 1 pattern, broadest browser support):

a) Canvas and SignaturePad initialization:
   var canvas = document.getElementById('signature-canvas');
   var signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
   WHITE BACKGROUND IS MANDATORY — without it, exported PNG has black background.

b) resizeCanvas function (DPI-aware):
   var ratio = Math.max(window.devicePixelRatio || 1, 1);
   canvas.width = canvas.offsetWidth * ratio;
   canvas.height = canvas.offsetHeight * ratio;
   canvas.getContext('2d').scale(ratio, ratio);
   signaturePad.clear();   // MUST call clear() after resize — fixes isEmpty() false positive bug
   Bind to window resize event AND call once immediately.

c) Clear button handler:
   document.getElementById('clear-btn').addEventListener('click', function () {
     signaturePad.clear();
     statusMsg.textContent = '';
     statusMsg.className = 'error-msg';  // reset to hidden default
   });

d) Submit button handler (Pattern 2 from research):
   - Check signaturePad.isEmpty() — if true, show "אנא חתום לפני השליחה" in status-msg with error-msg visible class, return early
   - Get data URL: var dataUrl = signaturePad.toDataURL('image/png');
   - Disable submit button, change text to "שולח..."
   - fetch('api/save-signature.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ signature: dataUrl }) })
   - On success (data.ok === true): hide #signing-area (display none), show "החתימה נשמרה. תודה!" as success-msg visible
   - On failure (data.ok === false): show data.message or "שגיאה בשמירת החתימה" as error-msg visible, re-enable button, restore text to "שלח"
   - On network error (.catch): show "שגיאת תקשורת — נסה שוב" as error-msg visible, re-enable button, restore text
   - On success, do NOT re-enable the button — hide the entire signing area to prevent double submission

IMPORTANT anti-patterns to avoid:
- Do NOT add session_start or auth guard — this page is public
- Do NOT use v4 onBegin/onEnd callback options — use addEventListener if needed (but for this task, no stroke events are required)
- Do NOT forget touch-action: none on canvas CSS
- Do NOT forget signaturePad.clear() in resizeCanvas
- Do NOT forget backgroundColor: 'rgb(255, 255, 255)' in SignaturePad options
  </action>
  <verify>
Verify file exists and contains key elements:
- grep "signature_pad@5.1.3" sign.html (CDN pinned to correct version)
- grep "touch-action: none" sign.html (mobile scroll prevention)
- grep "backgroundColor" sign.html (white background set)
- grep "signaturePad.clear()" sign.html (resize clear bug fix)
- grep "api/save-signature.php" sign.html (fetch endpoint path correct)
- grep "isEmpty()" sign.html (empty canvas check before submit)
- grep "user-scalable=no" sign.html (viewport prevents zoom)
- Confirm NO "session_start" or "check-session" references exist in the file
  </verify>
  <done>
sign.html exists in project root with: signature_pad v5.1.3 CDN, DPI-aware canvas with touch-action:none, white backgroundColor, resizeCanvas with clear(), submit handler with isEmpty check and fetch POST to api/save-signature.php, clear button, Hebrew RTL layout with title "חתום פה", success hides signing area to prevent re-submission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create api/save-signature.php — base64 PNG receive, GD validate, save, confirmation SMS</name>
  <files>api/save-signature.php</files>
  <action>
Create api/save-signature.php following the exact PHP patterns established in Phase 1.

File structure (matches api/send-sms.php and api/login.php patterns):
- Start with opening PHP tag only: &lt;?php (no closing ?> — prevents "headers already sent")
- Docblock comment explaining: receives base64 PNG from signing page, validates, saves to signatures/, sends confirmation SMS. Request/Response format documented.
- NOTE in docblock: No session auth — signing URL is the access control token.

Implementation (follow Pattern 4 from 02-RESEARCH.md closely):

1. NO session_start() — this endpoint is intentionally public
2. require_once __DIR__ . '/config.php';
3. header('Content-Type: application/json; charset=utf-8');

4. Parse JSON body using php://input (NOT $_POST — Phase 1 decision):
   $body = json_decode(file_get_contents('php://input'), true);
   $dataUrl = $body['signature'] ?? '';

5. Validate data URL prefix:
   if (strpos($dataUrl, 'data:image/png;base64,') !== 0) → 400 JSON error "Invalid image data"

6. Strip prefix and base64_decode with strict mode:
   $base64Data = substr($dataUrl, strlen('data:image/png;base64,'));
   $imageData = base64_decode($base64Data, true);
   If false → 400 JSON error "Base64 decode failed"

7. GD validation:
   $gdImage = imagecreatefromstring($imageData);
   If false → 400 JSON error "Invalid image content"

8. Generate filename and save:
   $filename = uniqid('sig_', true) . '.png';
   $savePath = __DIR__ . '/../signatures/' . $filename;
   $saved = imagepng($gdImage, $savePath);
   imagedestroy($gdImage);
   If !$saved → 500 JSON error "Failed to save signature file"

9. Confirmation SMS (NOTF-01) — reuse Phase 1 Micropay pattern VERBATIM from send-sms.php:
   $messageUtf8 = 'המסמך נחתם';
   $messageEncoded = iconv('UTF-8', 'ISO-8859-8', $messageUtf8);
   Build query params with http_build_query: get=1, token=MICROPAY_TOKEN, msg=$messageEncoded, list=ADMIN_PHONE, charset=iso-8859-8, from=Chemo IT
   $smsUrl = 'http://www.micropay.co.il/ExtApi/ScheduleSms.php?' . $params;
   cURL: CURLOPT_RETURNTRANSFER true, CURLOPT_TIMEOUT 10, capture result and error, close handle

10. Return success JSON regardless of SMS result (signature is already saved):
    echo json_encode(['ok' => true, 'file' => $filename, 'sms_result' => $smsError !== '' ? 'error: ' . $smsError : $smsResult]);

CRITICAL design decision: SMS failure does NOT cause ok:false. The signature is the record of truth; SMS is just notification. Include sms_result for debugging (matches Phase 1 pattern of including raw Micropay response).

Error responses use http_response_code() for each error path (400, 500). Success path returns default 200.

IMPORTANT: No closing ?> tag at end of file (Phase 1 decision — prevents accidental whitespace output).
  </action>
  <verify>
Verify file exists and contains key elements:
- grep "imagecreatefromstring" api/save-signature.php (GD validation present)
- grep "imagepng" api/save-signature.php (GD save present)
- grep "uniqid" api/save-signature.php (unique filename generation)
- grep "php://input" api/save-signature.php (correct JSON body reading)
- grep "iconv" api/save-signature.php (Hebrew SMS encoding)
- grep "micropay" api/save-signature.php (SMS API call)
- grep "ADMIN_PHONE" api/save-signature.php (uses config constant)
- Confirm NO "session_start" in file (endpoint is public)
- Confirm NO closing "?>" at end of file
  </verify>
  <done>
api/save-signature.php exists with: JSON body parsing via php://input, data URL prefix validation, base64 strict decode, GD imagecreatefromstring validation, uniqid filename, imagepng save to signatures/, iconv Hebrew confirmation SMS via Micropay cURL, ok:true returned even if SMS fails, no session auth, no closing PHP tag.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. sign.html exists in project root alongside index.html and dashboard.html
2. api/save-signature.php exists in api/ alongside send-sms.php and config.php
3. sign.html loads signature_pad v5.1.3 from jsdelivr CDN
4. sign.html canvas has touch-action:none CSS for mobile drawing
5. sign.html submit handler POSTs to api/save-signature.php with JSON body
6. api/save-signature.php validates PNG with GD before saving
7. api/save-signature.php sends confirmation SMS reusing Phase 1 Micropay pattern
8. Neither file has session auth (both are public-facing)
9. Both files follow Phase 1 PHP/HTML conventions (no closing ?>, Hebrew RTL, same CSS patterns)
</verification>

<success_criteria>
- sign.html is a complete, self-contained signing page that renders correctly on mobile (Hebrew RTL, canvas with touch support, clear/submit buttons)
- api/save-signature.php receives, validates, saves PNG, and sends confirmation SMS
- Both files are committed and ready for deployment + human testing in Plan 02-02
</success_criteria>

<output>
After completion, create `.planning/phases/02-signature-capture-and-confirmation/02-01-SUMMARY.md`
</output>
